<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>COF Candidate Explorer</title>
  <style>
    .modal{display:none;position:fixed;inset:0;z-index:100;background:rgba(15,23,42,.9);backdrop-filter:blur(8px)}
    .modal-content{background:white;margin:2% auto;width:95%;max-width:980px;border-radius:1rem;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,.5)}
    .chip{border:1px solid #e2e8f0;background:#f1f5f9;color:#475569;padding:2px 8px;border-radius:999px;font-weight:700;font-size:.72rem}
    .card:hover{border-color:#3b82f6;transform:translateY(-2px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">
  <nav class="bg-slate-900 text-white sticky top-0 z-40 px-6 py-4 shadow-xl">
    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="bg-blue-600 p-2 rounded-lg font-black text-xl leading-none">3D</div>
        <div>
          <h1 class="text-xl font-bold tracking-tight leading-tight">COF Candidate Explorer</h1>
          <p id="datasetCount" class="text-[10px] text-blue-300 font-bold uppercase tracking-[0.2em]">Loading...</p>
        </div>
      </div>
      <div class="w-full lg:w-[720px] grid grid-cols-1 md:grid-cols-3 gap-2">
        <input id="searchInput" type="text" placeholder="Search (topology, linker, SG, CN like 6-2...)"
          class="w-full px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder-slate-500">
        <select id="topologyFilter" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white">
          <option value="">All topologies</option>
        </select>
        <div class="grid grid-cols-2 gap-2">
          <select id="priorityFilter" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white">
            <option value="">All priority</option>
            <option>High</option><option>Med</option><option>Low</option>
          </select>
          <select id="statusFilter" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white">
            <option value="">All status</option>
            <option>Proposed</option><option>Discussing</option><option>In synthesis</option>
            <option>Success</option><option>Failed</option><option>Dropped</option>
          </select>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-6 md:p-8">
    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    <div id="noResult" class="hidden text-center py-20 text-slate-400 font-medium">검색 결과가 없습니다.</div>
    <div id="loadError" class="hidden text-center py-20 text-red-500 font-medium">
      data.json 로딩 실패. index.html과 data.json이 같은 폴더인지 확인.
    </div>
  </main>

  <div id="modal" class="modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-content">
      <div class="bg-slate-900 px-8 py-6 text-white flex justify-between items-center">
        <div class="min-w-0">
          <h2 id="mTitle" class="text-2xl md:text-3xl font-black tracking-tighter text-blue-400 italic truncate"></h2>
          <p id="mSub" class="text-slate-300 font-mono text-xs md:text-sm mt-1"></p>
          <div id="mChips" class="mt-3 flex flex-wrap gap-2"></div>
        </div>
        <button id="mClose" onclick="closeModal()" class="text-4xl leading-none text-slate-500 hover:text-white transition-colors">&times;</button>
      </div>

      <div class="p-8 bg-white space-y-8">
        <p id="mNotes" class="text-sm text-slate-600 leading-relaxed"></p>

        <div class="grid md:grid-cols-2 gap-8">
          <div class="space-y-3">
            <div class="border-b border-slate-100 pb-2">
              <span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Node 1</span>
            </div>
            <div id="mNode1" class="divide-y divide-slate-50"></div>
          </div>
          <div class="space-y-3">
            <div class="border-b border-slate-100 pb-2">
              <span class="bg-emerald-100 text-emerald-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Node 2</span>
            </div>
            <div id="mNode2" class="divide-y divide-slate-50"></div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="border-b border-slate-100 pb-2">
            <span class="bg-violet-100 text-violet-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Linker Pair</span>
          </div>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="border border-slate-200 rounded-xl p-4 bg-slate-50">
              <p class="text-xs text-slate-400 font-bold uppercase">Linker A</p>
              <p id="mLA" class="font-black text-slate-900 mt-1"></p>
            </div>
            <div class="border border-slate-200 rounded-xl p-4 bg-slate-50">
              <p class="text-xs text-slate-400 font-bold uppercase">Linker B</p>
              <p id="mLB" class="font-black text-slate-900 mt-1"></p>
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="border-b border-slate-100 pb-2">
            <span class="bg-amber-100 text-amber-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Metrics</span>
          </div>
          <div id="mMetrics" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const noResult = document.getElementById('noResult');
    const loadError = document.getElementById('loadError');
    const searchInput = document.getElementById('searchInput');
    const topologyFilter = document.getElementById('topologyFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const statusFilter = document.getElementById('statusFilter');

    let data = [];
    let byId = new Map();

    function safeText(v){ return (v===null||v===undefined) ? '' : String(v); }
    function fmtNum(v){
      if(v===null||v===undefined||v==='') return '';
      const n = Number(v);
      if(Number.isNaN(n)) return safeText(v);
      return Number.isInteger(n) ? String(n) : String(Math.round(n*1000)/1000);
    }
    function buildSearchText(item){
      const o1=item.nodes?.o1||{}, o2=item.nodes?.o2||{};
      const cnKey = `${fmtNum(o1.cn)}-${fmtNum(o2.cn)}`;
      return [
        item.id,item.topology,item.sg,
        o1.geo,o2.geo,o1.type,o2.type,o1.z,o2.z,cnKey,
        item.linkers?.A?.name,item.linkers?.B?.name,
        ...(item.conf||[])
      ].filter(Boolean).join(' ').toLowerCase();
    }
    function uniqSorted(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b)); }

    function cardHTML(item){
      const o1=item.nodes?.o1||{}, o2=item.nodes?.o2||{};
      return `
        <div class="card bg-white rounded-xl border border-slate-200 cursor-pointer transition-all overflow-hidden" data-id="${item.id}">
          <div class="p-4 flex flex-col gap-2">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="text-[11px] text-slate-400 font-mono truncate">${safeText(item.id)}</div>
                <h3 class="text-lg font-black text-slate-800 leading-none truncate">${safeText(item.topology).toUpperCase()}</h3>
                <p class="text-[10px] text-slate-400 font-mono mt-1 truncate">${safeText(item.sg)}</p>
              </div>
              <div class="flex flex-col items-end gap-1">
                ${item.priority ? `<span class="text-[10px] font-black px-2 py-0.5 rounded bg-slate-100 text-slate-700 uppercase">${safeText(item.priority)}</span>` : ``}
                ${item.status ? `<span class="text-[10px] font-black px-2 py-0.5 rounded bg-slate-100 text-slate-700 uppercase">${safeText(item.status)}</span>` : ``}
              </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-1">
              <span class="chip">CN ${fmtNum(o1.cn)}</span>
              <span class="chip">CN ${fmtNum(o2.cn)}</span>
              ${item.linkers?.A?.name ? `<span class="chip truncate max-w-[240px]">A: ${safeText(item.linkers.A.name)}</span>` : ``}
              ${item.linkers?.B?.name ? `<span class="chip truncate max-w-[240px]">B: ${safeText(item.linkers.B.name)}</span>` : ``}
            </div>
          </div>
        </div>`;
    }

    function render(list){
      if(!list.length){ grid.innerHTML=''; noResult.classList.remove('hidden'); return; }
      noResult.classList.add('hidden');
      grid.innerHTML = list.map(cardHTML).join('');
      grid.querySelectorAll('[data-id]').forEach(el=>{
        el.addEventListener('click', ()=>openModalById(el.getAttribute('data-id')));
      });
    }

    function row(label,val){
      return `<div class="flex justify-between py-2 text-sm gap-4">
        <span class="text-slate-400 font-medium">${label}</span>
        <span class="text-slate-800 font-bold text-right">${val}</span>
      </div>`;
    }
    function renderNode(node){
      return [
        row("Geometry", safeText(node.geo)),
        row("CN / Type", `${fmtNum(node.cn)} / ${safeText(node.type)}`),
        row("δ (Delta)", `${fmtNum(node.d)}°`),
        row("η (Eta)", `${fmtNum(node.e)}°`),
        row("θ (Theta)", `${fmtNum(node.t)}°`),
        row("Zigzag", safeText(node.z))
      ].join('');
    }
    function metricCard(k,v){
      const label = safeText(k).replaceAll('_',' ').toUpperCase();
      return `<div class="border border-slate-200 rounded-xl p-4 bg-slate-50">
        <div class="text-[10px] font-black text-slate-400 uppercase">${label}</div>
        <div class="text-xl font-black text-slate-900 mt-1">${fmtNum(v)}</div>
      </div>`;
    }

    function applyFilters(){
      const q = searchInput.value.toLowerCase().trim();
      const topo = topologyFilter.value;
      const pri = priorityFilter.value;
      const sta = statusFilter.value;

      const filtered = data.filter(item=>{
        if(topo && item.topology!==topo) return false;
        if(pri && item.priority!==pri) return false;
        if(sta && item.status!==sta) return false;
        if(q && !item._search.includes(q)) return false;
        return true;
      });
      render(filtered);
      document.getElementById('datasetCount').innerText = `${filtered.length} / ${data.length} Candidates`;
    }

    function openModalById(id){
      const item = byId.get(id);
      if(!item) return;
      document.getElementById('mTitle').innerText = safeText(item.topology).toUpperCase();
      document.getElementById('mSub').innerText = `ID: ${safeText(item.id)} | Space Group: ${safeText(item.sg)}`;
      document.getElementById('mNotes').innerText = safeText(item.notes) || "—";

      document.getElementById('mLA').innerText = safeText(item.linkers?.A?.name) || "—";
      document.getElementById('mLB').innerText = safeText(item.linkers?.B?.name) || "—";

      const o1=item.nodes?.o1||{}, o2=item.nodes?.o2||{};
      document.getElementById('mNode1').innerHTML = renderNode(o1);
      document.getElementById('mNode2').innerHTML = renderNode(o2);

      const metrics=item.metrics||{};
      const keys=Object.keys(metrics);
      document.getElementById('mMetrics').innerHTML = keys.length ? keys.map(k=>metricCard(k,metrics[k])).join('')
        : `<div class="text-slate-400 text-sm">No metrics provided.</div>`;

      document.getElementById('modal').style.display='block';
      document.body.style.overflow='hidden';
      setTimeout(()=>document.getElementById('mClose').focus(),0);
    }
    function closeModal(){
      document.getElementById('modal').style.display='none';
      document.body.style.overflow='auto';
    }
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });

    [searchInput, topologyFilter, priorityFilter, statusFilter].forEach(el=>{
      el.addEventListener('input', applyFilters);
      el.addEventListener('change', applyFilters);
    });

    async function init(){
      try{
        const res = await fetch('./data.json', {cache:'no-store'});
        if(!res.ok) throw new Error('fetch failed');
        data = await res.json();
        data.forEach(item=>{
          item._search = buildSearchText(item);
          byId.set(item.id, item);
        });
        uniqSorted(data.map(x=>x.topology)).forEach(t=>{
          const opt=document.createElement('option');
          opt.value=t; opt.textContent=t;
          topologyFilter.appendChild(opt);
        });
        document.getElementById('datasetCount').innerText = `${data.length} Candidates`;
        applyFilters();
      }catch(err){
        console.error(err);
        loadError.classList.remove('hidden');
      }
    }
    init();
  </script>
</body>
</html>
